/*
 * uart.c
 *
 *  Created on: Dec 19, 2025
 *      Author: Admin
 */


#define RCC_BASE_ADDR      0x40023800UL
#define GPIOA_BASE_ADDR    0x40020000UL
#define USART1_BASE_ADDR   0x40011000UL


void CHI_UART_Transmit(uint8_t data)
{
    uint32_t* USART_SR = (uint32_t*)(USART1_BASE_ADDR + 0x00);
    uint32_t* USART_DR = (uint32_t*)(USART1_BASE_ADDR + 0x04);

    while(((*USART_SR >> 7) & 1) == 0);   // TXE
    *USART_DR = data;
    while(((*USART_SR >> 6) & 1) == 0);   // TC
}

void CHI_UART_init(void)
{
    /* ===== Enable clocks ===== */
    uint32_t* RCC_AHB1ENR = (uint32_t*)(RCC_BASE_ADDR + 0x30);
    uint32_t* RCC_APB2ENR = (uint32_t*)(RCC_BASE_ADDR + 0x44);

    *RCC_AHB1ENR |= (1 << 0);    // GPIOA clock
    *RCC_APB2ENR |= (1 << 4);    // USART1 clock

    /* ===== GPIO PA9, PA10 alternate function ===== */
    uint32_t* GPIOA_MODER = (uint32_t*)(GPIOA_BASE_ADDR + 0x00);
    uint32_t* GPIOA_AFRH  = (uint32_t*)(GPIOA_BASE_ADDR + 0x24);

    /* PA9 -> USART1_TX (AF7) */
    *GPIOA_MODER &= ~(0b11 << (9 * 2));
    *GPIOA_MODER |=  (0b10 << (9 * 2));
    *GPIOA_AFRH  &= ~(0xF << ((9 - 8) * 4));
    *GPIOA_AFRH  |=  (0x7 << ((9 - 8) * 4));

    /* PA10 -> USART1_RX (AF7) */
    *GPIOA_MODER &= ~(0b11 << (10 * 2));
    *GPIOA_MODER |=  (0b10 << (10 * 2));
    *GPIOA_AFRH  &= ~(0xF << ((10 - 8) * 4));
    *GPIOA_AFRH  |=  (0x7 << ((10 - 8) * 4));

    /* ===== USART1 configuration ===== */
    uint32_t* USART1_BRR = (uint32_t*)(USART1_BASE_ADDR + 0x08);
    uint32_t* USART1_CR1 = (uint32_t*)(USART1_BASE_ADDR + 0x0C);

    /* Baudrate = 9600, PCLK2 = 16 MHz
       USARTDIV = 16MHz / (16 * 9600) = 104.166 */
    *USART1_BRR = (104 << 4) | (3 << 0);

    *USART1_CR1 = 0;
    *USART1_CR1 &= ~(1 << 15);   // Oversampling 16
    *USART1_CR1 &= ~(1 << 12);   // 8-bit data
    *USART1_CR1 &= ~(1 << 10);   // No parity
    *USART1_CR1 |=  (1 << 2);    // RE
    *USART1_CR1 |=  (1 << 3);    // TE
    *USART1_CR1 |=  (1 << 13);   // UE
}

void CHI_UART_send_number(int num)
{
    char buf[12];
    int i = 0;

    if (num == 0)
    {
        CHI_UART_Transmit('0');
        return;
    }

    if (num < 0)
    {
        CHI_UART_Transmit('-');
        num = -num;
    }

    while (num > 0)
    {
        buf[i++] = (num % 10) + '0';
        num /= 10;
    }

    while (i--)
        CHI_UART_Transmit(buf[i]);
}


void CHI_UART_print_log(char *m)
{
    for (int i = 0; m[i]; i++)
    {
        CHI_UART_Transmit((uint8_t)m[i]);
    }
}

void CHI_UART_send_float(float v)
{
    if (v < 0)
    {
        CHI_UART_Transmit('-');
        v = -v;
    }

    int ip = (int)v;
    int fp = (int)((v - ip) * 100);

    CHI_UART_send_number(ip);
    CHI_UART_Transmit('.');

    if (fp < 10)
        CHI_UART_Transmit('0');

    CHI_UART_send_number(fp);
    CHI_UART_Transmit('\r');
    CHI_UART_Transmit('\n');
}
